<script>
  var spec = {{{ chartParams }}}

  var map = L.map(spec.dom, spec.mapOpts)
  var baseLayers = {
	'VWorld Street Map': L.Proj.TileLayer.TMS.provider('VWorld.Street'),
	'VWorld Satellite Map' : L.Proj.TileLayer.TMS.provider('VWorld.Satellite').addTo(map),
	'OpenStreetMap German Style': L.tileLayer.provider('OpenStreetMap.DE'),
	'OpenStreetMap Black and White': L.tileLayer.provider('OpenStreetMap.BlackAndWhite'),
	'Esri WorldStreetMap': L.tileLayer.provider('Esri.WorldStreetMap'),
  };

  var overlayLayers = {
	'VWorld Hybrid Map' : L.Proj.TileLayer.TMS.provider('VWorld.Hybrid').addTo(map),
	'OpenSeaMap': L.tileLayer.provider('OpenSeaMap'),
	'OpenWeatherMap Clouds': L.tileLayer.provider('OpenWeatherMap.Clouds'),
	'OpenWeatherMap CloudsClassic': L.tileLayer.provider('OpenWeatherMap.CloudsClassic'),
	'OpenWeatherMap Precipitation': L.tileLayer.provider('OpenWeatherMap.Precipitation'),
	// uncomment these lines if your screen is really large
	//'OpenWeatherMap PrecipitationClassic': L.tileLayer.provider('OpenWeatherMap.PrecipitationClassic'),
	//'OpenWeatherMap Rain': L.tileLayer.provider('OpenWeatherMap.Rain'),
	//'OpenWeatherMap RainClassic': L.tileLayer.provider('OpenWeatherMap.RainClassic'),
	//'OpenWeatherMap Pressure': L.tileLayer.provider('OpenWeatherMap.Pressure'),
	//'OpenWeatherMap PressureContour': L.tileLayer.provider('OpenWeatherMap.PressureContour'),
	//'OpenWeatherMap Wind': L.tileLayer.provider('OpenWeatherMap.Wind'),
	//'OpenWeatherMap Temperature': L.tileLayer.provider('OpenWeatherMap.Temperature'),
	'OpenWeatherMap Snow': L.tileLayer.provider('OpenWeatherMap.Snow')
  };

  L.control.layers(baseLayers, overlayLayers, {collapsed: false}).addTo(map);
    
  {{^ addons.kml }}
    map.setView(spec.center, spec.zoom);
  {{/ addons.kml }}



     
    {{{ marker }}}
    
    {{{ circle }}}
    
    
    if (spec.circle2){
      for (var c in spec.circle2){
        var circle = L.circle(c.center, c.radius, c.opts)
         .addTo(map);
      }
    }
    
    {{# addons.geocsv }}
      var geo_csv = L.geoCSV(null, {
        titles: spec.geocsv.titles,
        fieldSeparator: ';',
        lineSeparator: '\n',
        deleteDobleQuotes: true,
        firstLineTitles: false,
          onEachFeature: function (feature, layer) {
        var popup = '';
          for (var clave in feature.properties) {
            var title = geo_csv.getPropertyTitle(clave);
            popup += '<b>'+title+'</b><br />'+feature.properties[clave]+'<br /><br />';
          }
          layer.bindPopup(popup);
        }
      })
    
      geo_csv.addData(spec.geocsv.data)
      map.addLayer(geo_csv)
    {{/ addons.geocsv }}
    
    {{# addons.enablePopover }}
      var popup = L.popup();
      function onMapClick(e) {
        popup
          .setLatLng(e.latlng)
          .setContent("<b>Latitude:</b> " + e.latlng.lat.toFixed(2) + "<br />" +
            "<b>Longitude:</b> " + e.latlng.lng.toFixed(2))
          .openOn(map);
      }
      map.on('click', onMapClick);
    {{/ addons.enablePopover }}
    
    
    {{# addons.geoJson }}
    var geojsonLayer = L.geoJson(spec.features 
        {{# geoJson }}, 
         {{{ geoJson }}}
        {{/ geoJson }}
      ).addTo(map)
    {{/ addons.geoJson }}
    
    {{#addons.legend}}
    var legend = L.control({position: spec.legend.position});
    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend'),
          labels = spec.legend.labels,
          colors = spec.legend.colors

      // loop through our density intervals and generate a 
      // label with a colored square for each interval
      for (var i = 0; i < labels.length; i++) {
          div.innerHTML += '<i style="background:' +  colors[i] + '"></i>' + 
            labels[i] + "<br>"
      }
     return div;
    };
    legend.addTo(map); 
   {{/addons.legend}}
   
   {{#addons.fullscreen}}
   
     L.control.fullscreen({
       position: 'topleft',
       title: 'Show me the fullscreen !'
    }).addTo(map);
   
   {{/addons.fullscreen}}
   
   {{#addons.kml}}
   var kmlLayer = new L.KML({{{ kml }}}, {async: true});
                                                              
   kmlLayer.on("loaded", function(e) { 
        map.fitBounds(e.target.getBounds());
   });
                                                
   map.addLayer(kmlLayer);
   {{/addons.kml}}
   
</script>
